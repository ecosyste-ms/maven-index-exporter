# Maven Index Exporter .fld File Format Documentation

## Overview

The `.fld` file is a text-based export of Lucene stored fields from a Maven repository index. It's generated by the `clue` tool (part of maven-index-exporter) and contains all indexed artifact information.

## File Structure

The file consists of sequential documents (one per artifact), each with multiple fields:

```
doc <number>
  field <number>
    name <field_name>
    type <field_type>
    value <field_value>
  field <number>
    name <field_name>
    type <field_type>
    value <field_value>
  ...
doc <number>
  ...
```

## Field Reference

### Primary Fields

#### `u` - UINFO (Unique Artifact Info)
**Format:** `groupId|artifactId|version|classifier|packaging`

**Example:**
```
name u
type string
value org.opensaml|opensaml-core|4.3.2|NA|jar
```

**Parsing:**
- `parts[0]` = groupId (e.g., `org.opensaml`)
- `parts[1]` = artifactId (e.g., `opensaml-core`)
- `parts[2]` = version (e.g., `4.3.2`)
- `parts[3]` = classifier (e.g., `NA` for none, or `sources`, `javadoc`)
- `parts[4]` = packaging (e.g., `jar`, `pom`, `war`)

**Package Name:** `groupId:artifactId` (e.g., `org.opensaml:opensaml-core`)

#### `m` - Last Modified
**Format:** Unix timestamp in milliseconds

**Example:**
```
name m
type string
value 1712857503000
```

**Parsing:**
```ruby
timestamp_ms = value.to_i
Time.at(timestamp_ms / 1000)  # => 2024-04-11 18:45:03 UTC
```

#### `i` - INFO
**Format:** `packaging|lastModified|size|hasSource|hasJavadoc|hasSignature|packaging`

**Example:**
```
name i
type string
value jar|1712857503000|673001|1|1|1|jar
```

**Parsing:**
- `parts[0]` = packaging type
- `parts[1]` = last modified timestamp (milliseconds)
- `parts[2]` = file size in bytes
- `parts[3]` = has source JAR? (1=yes, 0=no)
- `parts[4]` = has javadoc JAR? (1=yes, 0=no)
- `parts[5]` = has signature? (1=yes, 0=no)
- `parts[6]` = packaging type (duplicate)

### Optional Metadata Fields

#### `n` - NAME
Project/artifact name (human-readable)

**Example:**
```
name n
type string
value OpenSAML Core Library
```

#### `d` - DESCRIPTION
Project description

**Example:**
```
name d
type string
value OpenSAML is a set of open source C++ & Java libraries for SAML
```

#### `1` - SHA1
SHA-1 checksum of the artifact

**Example:**
```
name 1
type string
value 6fd85523ede1bd431de1099b822ee55d4d08b7ea
```

#### `2` - SHA256
SHA-256 checksum (newer indexes)

**Example:**
```
name 2
type string
value a1b2c3d4e5f6...
```

#### `5` - MD5
MD5 checksum (deprecated, older indexes)

**Example:**
```
name 5
type string
value d41d8cd98f00b204e9800998ecf8427e
```

### Advanced Fields

#### `c` - CLASS_NAMES
Fully qualified class names contained in the JAR (useful for searching)

**Example:**
```
name c
type string
value /org/opensaml/core/xml/XMLObject\
/org/opensaml/core/xml/XMLObjectBuilder\
/org/opensaml/core/config/Configuration\
...
```

**Format:** Newline-separated list with `/` instead of `.` in package names

#### `p` - PLUGIN_PREFIX
Maven plugin prefix (only for Maven plugins)

**Example:**
```
name p
type string
value compiler
```

#### `g` - PLUGIN_GOALS
Available plugin goals (only for Maven plugins)

**Example:**
```
name g
type string
value compile|testCompile|help
```

### OSGi/Bundle Fields

For OSGi bundles, additional fields may be present:

- `Bundle-SymbolicName` - OSGi bundle symbolic name
- `Bundle-Version` - OSGi bundle version
- `Bundle-Description` - Bundle description
- `Export-Package` - Exported packages
- `Import-Package` - Imported packages

## Complete Field List

Based on Maven Indexer API documentation:

| Field Name | Maven Indexer Constant | Description |
|------------|----------------------|-------------|
| `u` | UINFO | Unique info (groupId\|artifactId\|version\|classifier\|ext) |
| `m` | LAST_MODIFIED | Last modified timestamp (ms) |
| `i` | INFO | Info (packaging\|timestamp\|size\|sourcesExists\|javadocExists\|signatureExists\|packaging) |
| `g` | GROUP_ID | Group ID |
| `a` | ARTIFACT_ID | Artifact ID |
| `v` | VERSION | Version |
| `e` | PACKAGING | Packaging type |
| `l` | CLASSIFIER | Classifier |
| `n` | NAME | Artifact name |
| `d` | DESCRIPTION | Description |
| `1` | SHA1 | SHA-1 hash |
| `2` | SHA256 | SHA-256 hash (newer) |
| `5` | MD5 | MD5 hash (deprecated) |
| `c` | CLASS_NAMES | Class names in JAR |
| `p` | PLUGIN_PREFIX | Maven plugin prefix |
| `g` | PLUGIN_GOALS | Plugin goals |

## Parsing Examples

### Simple Parser (Extract Package Names)

```ruby
packages = []

File.foreach("export/_1.fld") do |line|
  line.strip!

  if line == "name u"
    @reading_uinfo = true
  elsif @reading_uinfo && line.start_with?("value ")
    value = line.sub("value ", "")
    parts = value.split("|")
    group_id = parts[0]
    artifact_id = parts[1]

    packages << "#{group_id}:#{artifact_id}"
    @reading_uinfo = false
  end
end

puts packages.uniq
```

### Full Parser (Extract All Data)

```ruby
class FldParser
  def self.parse(file_path)
    artifacts = []
    current_artifact = {}
    current_field = nil

    File.foreach(file_path) do |line|
      line.strip!

      case line
      when /^doc (\d+)/
        artifacts << current_artifact unless current_artifact.empty?
        current_artifact = { doc_id: $1.to_i }

      when /^name (.+)/
        current_field = $1

      when /^value (.+)/
        value = $1

        case current_field
        when 'u'  # UINFO
          parts = value.split('|')
          current_artifact[:group_id] = parts[0]
          current_artifact[:artifact_id] = parts[1]
          current_artifact[:version] = parts[2]
          current_artifact[:classifier] = parts[3]
          current_artifact[:packaging] = parts[4]

        when 'm'  # Last Modified
          current_artifact[:last_modified] = Time.at(value.to_i / 1000)

        when 'i'  # INFO
          parts = value.split('|')
          current_artifact[:size] = parts[2].to_i
          current_artifact[:has_sources] = parts[3] == '1'
          current_artifact[:has_javadoc] = parts[4] == '1'
          current_artifact[:has_signature] = parts[5] == '1'

        when 'n'  # NAME
          current_artifact[:name] = value

        when 'd'  # DESCRIPTION
          current_artifact[:description] = value

        when '1'  # SHA1
          current_artifact[:sha1] = value
        end

        current_field = nil
      end
    end

    artifacts << current_artifact unless current_artifact.empty?
    artifacts
  end
end

# Usage
artifacts = FldParser.parse("export/_1.fld")
puts "Total artifacts: #{artifacts.size}"
```

### SQL-like Query Examples

```bash
# Get all Spring Framework artifacts
grep -A 3 'name u$' export/_1.fld | \
  grep 'value' | \
  grep 'org.springframework' | \
  sed 's/.*value //' | \
  awk -F'|' '{print $1":"$2" version "$3}'

# Find all version 4.3.2 artifacts
grep -A 3 'name u$' export/_1.fld | \
  grep 'value' | \
  grep '|4.3.2|' | \
  sed 's/.*value //' | \
  awk -F'|' '{print $1":"$2}'

# Count artifacts by groupId
grep -A 3 'name u$' export/_1.fld | \
  grep 'value' | \
  sed 's/.*value //' | \
  awk -F'|' '{print $1}' | \
  sort | uniq -c | sort -rn
```

## Performance Considerations

- **File Size:** Shibboleth = 26MB, Maven Central = ~15GB (uncompressed)
- **Parsing Speed:** ~1-2 seconds for Shibboleth (210 packages), ~5-10 minutes for Maven Central (600k+ packages)
- **Memory:** Stream parsing recommended for large files (don't load entire file into memory)
- **Storage:** Keep compressed `.gz` files, delete `.fld` after parsing

## Known Issues

1. **Duplicate versions:** Some artifacts appear multiple times with the same version (different classifiers like sources, javadoc)
2. **Missing fields:** Not all artifacts have descriptions or names
3. **Encoding:** Some descriptions may contain UTF-8 characters
4. **Line breaks:** Description and class name fields can span multiple lines

## References

- Maven Indexer API: https://maven.apache.org/maven-indexer/apidocs/
- ArtifactInfo Fields: https://maven.apache.org/maven-indexer-archives/maven-indexer-6.0.0/indexer-core/apidocs/org/apache/maven/index/ArtifactInfo.html
- Clue Tool: https://github.com/javasoze/clue
- Maven Index Exporter: https://github.com/borisbaldassari/maven-index-exporter

## Example Output

Here's a complete example of one artifact entry:

```
doc 42
  field 0
    name u
    type string
    value org.opensaml|opensaml-core|4.3.2|NA|jar
  field 1
    name m
    type string
    value 1712857503000
  field 2
    name i
    type string
    value jar|1712857503000|673001|1|1|1|jar
  field 10
    name n
    type string
    value OpenSAML Core
  field 11
    name d
    type string
    value Core library for OpenSAML
  field 13
    name 1
    type string
    value 6fd85523ede1bd431de1099b822ee55d4d08b7ea
```

**Parsed as:**
- Package: `org.opensaml:opensaml-core`
- Version: `4.3.2`
- Last Modified: April 11, 2024 18:45:03 UTC
- Size: 673,001 bytes
- Has Sources: Yes
- Has Javadoc: Yes
- SHA1: `6fd85523ede1bd431de1099b822ee55d4d08b7ea`
